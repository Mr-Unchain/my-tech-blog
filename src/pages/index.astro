---
// src/pages/index.astro
import { collection, getDocs, limit, orderBy, query } from "firebase/firestore";
import ArticleCard from "../components/ArticleCard.astro";
import HeroSlideshowReact from "../components/HeroSlideshowReact";
import Sidebar from "../components/Sidebar.astro";
import BaseLayout from "../layouts/BaseLayout.astro";
import { db } from "../lib/firebase";
import { getBlogs, type Blog } from "../lib/microcms";

// ★★★ ヒーローセクションの人気記事取得ロジック ★★★
const viewsQuery = query(
  collection(db, "views"),
  orderBy("count", "desc"),
  limit(3)
);
const querySnapshot = await getDocs(viewsQuery);
const popularPostIds = querySnapshot.docs.map((doc) => doc.id);

let heroPosts: Blog[] = [];
if (popularPostIds.length > 0) {
  const filters = popularPostIds.map((id) => `id[equals]${id}`).join("[or]");
  const { contents: microCMSData } = await getBlogs({
    filters: filters,
  });
  // Firestoreの順序を維持
  heroPosts = popularPostIds
    .map((id) => {
      const post = microCMSData.find((post: Blog) => post.id === id);
      if (!post) return undefined;
      return {
        ...post,
        category: Array.isArray(post.category)
          ? [...post.category]
          : [post.category],
      };
    })
    .filter((post): post is Blog => !!post);
}

// ★★★ 新しい記事一覧の取得ロジック（ページネーション対応） ★★★
const PAGE_SIZE = 20;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? Math.max(1, parseInt(pageParam)) : 1;
const offset = (currentPage - 1) * PAGE_SIZE;

// ★★★ 本番用：通常のページネーション・記事取得ロジックに戻す ★★★
const { contents: pagedPosts, totalCount } = await getBlogs({
  orders: "-publishedAt",
  limit: PAGE_SIZE,
  offset,
});
const totalPages = Math.ceil((totalCount || 0) / PAGE_SIZE);

// ★ カテゴリチップ（型安全に抽出）
const categoryChips: string[] = Array.from(
  new Set(
    (pagedPosts as Blog[]).flatMap((p: Blog) =>
      Array.isArray(p.category)
        ? (p.category as string[])
        : (p.category ? [String(p.category)] : [])
    )
  )
).slice(0, 6);
---

<BaseLayout
  pageTitle="技術ブログ - 最新の記事"
  pageDescription="Monologgerは、テクノロジー、ガジェット、開発に関する最新情報を発信する技術ブログです。プログラミング、Web開発、最新技術トレンドなどの記事をお届けします。"
  keywords="テクノロジー, ガジェット, 開発, プログラミング, Web開発, JavaScript, React, Astro, 技術ブログ"
>
  <Fragment slot="head">
    {
      // ファーストビューで使う画像を事前読み込み（最大6枚）
      [
        ...(heroPosts || []).slice(0,3).map((p: Blog) => p.eyecatch?.url).filter(Boolean),
        ...(pagedPosts || []).slice(0,3).map((p: Blog) => p.eyecatch?.url).filter(Boolean)
      ].slice(0,6).map((url: string) => (
        <link rel="preload" as="image" href={`${url}?w=800&q=70`} />
      ))
    }
  </Fragment>
  <!-- ホームページ用の構造化データ -->
  <script slot="head" type="application/ld+json">
    {
      JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Blog",
        "name": "Monologger",
        "description": "テクノロジー、ガジェット、開発に関する技術ブログ",
        "url": Astro.site,
        "author": {
          "@type": "Person",
          "name": "Monologger",
          "url": new URL("/profile", Astro.site).href
        },
        "publisher": {
          "@type": "Organization",
          "name": "Monologger",
          "logo": {
            "@type": "ImageObject",
            "url": new URL("/logo.svg", Astro.site).href
          }
        },
        "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": Astro.site
        },
        "blogPost": pagedPosts.slice(0, 10).map(post => ({
          "@type": "BlogPosting",
          "headline": post.title,
          "description": post.description,
          "url": new URL(`/blog/${post.id}`, Astro.site).href,
          "datePublished": post.publishedAt,
          "author": {
            "@type": "Person", 
            "name": "Monologger"
          },
          "image": post.eyecatch?.url || new URL("/placeholder.svg", Astro.site).href
        }))
      })
    }
  </script>
  <main class="min-h-screen bg-slate-900">
    <!-- First View (FB) -->
    <section class="relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-b from-slate-800/70 to-transparent" aria-hidden="true"></div>
      <div class="container mx-auto px-6 pt-10 pb-8 md:pt-16 md:pb-12 max-w-7xl relative">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center">
          <div class="lg:col-span-7 space-y-6">
            <h1 class="text-3xl md:text-5xl font-extrabold leading-tight bg-gradient-to-r from-white via-cyan-100 to-blue-100 bg-clip-text text-transparent">
              AIとガジェット、日々の“いいね”を残していくブログ。
            </h1>
            <p class="text-slate-300 text-base md:text-lg leading-relaxed">
              気になった技術・ツールを試して、役に立ったことだけメモしています。<br class="hidden md:block"/>
              ライトに読めて、ちょっと生活がラクになるヒントをどうぞ。
            </p>
            <form id="fv-search" method="get" action="/search" class="flex w-full max-w-3xl rounded-xl overflow-hidden border border-slate-700/60 bg-slate-800/60 backdrop-blur-sm shadow-lg">
              <input name="q" id="fv-q" list="fv-suggest" class="flex-1 px-4 py-3 bg-transparent text-slate-100 placeholder-slate-400 focus:outline-none" placeholder="なにを探しますか？（例: AI, ガジェット, 時短ツール）" />
              <datalist id="fv-suggest"></datalist>
              <button type="submit" class="px-5 md:px-6 bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-semibold hover:from-cyan-400 hover:to-blue-400">検索</button>
            </form>
            <div class="flex flex-wrap gap-2 pt-1">
              {categoryChips.map((c) => (
                <a href={`/category/${encodeURIComponent(c)}`} class="px-3 py-1 rounded-full text-sm border border-cyan-400/40 text-cyan-200 bg-cyan-500/10 hover:bg-cyan-500/20 transition">
                  #{c}
                </a>
              ))}
            </div>
          </div>
          <div class="lg:col-span-5 hidden lg:block">
            <div class="rounded-2xl border border-slate-700/60 bg-slate-800/40 backdrop-blur-sm p-6 shadow-xl">
              <div class="text-slate-300 text-sm">いま気になる</div>
              <div class="mt-3 grid grid-cols-2 gap-3">
                {pagedPosts.slice(0,4).map((p: Blog) => (
                  <a href={`/blog/${p.id}/`} class="group rounded-xl border border-slate-700/50 bg-slate-800/50 hover:border-cyan-400/60 hover:bg-slate-700/40 transition overflow-hidden">
                    <img src={(p.eyecatch?.url || '/placeholder.svg') + '?w=320&h=180&fit=crop'} alt={p.title} class="w-full h-24 object-cover" loading="lazy" decoding="async" />
                    <div class="p-3 text-xs text-slate-200 group-hover:text-white line-clamp-2">{p.title}</div>
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    {/* ★★★ ヒーローセクションをスライドショーに置き換え（React Island） ★★★ */}
    {
      heroPosts.length > 0 && (
        <div class="mb-8 md:mb-12">
          <HeroSlideshowReact client:idle posts={heroPosts} />
        </div>
      )
    }

    <div class="container mx-auto px-6 py-8 md:py-12 max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 lg:gap-12">
        <div class="lg:col-span-3">
          <!-- New Articles -->
          <section>
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-12 gap-6">
              <div class="flex items-center space-x-4">
                <div class="w-1.5 h-10 bg-gradient-to-b from-cyan-400 to-blue-500 rounded-full shadow-lg shadow-cyan-400/30"></div>
                <h2 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-white via-cyan-100 to-blue-100 bg-clip-text text-transparent">Latest Articles</h2>
              </div>
              <div class="flex space-x-3">
                <button
                  id="view-grid"
                  title="グリッド表示"
                  aria-label="記事をグリッド形式で表示"
                  class="p-4 rounded-xl bg-slate-800/80 text-cyan-400 border border-slate-700/50 shadow-lg hover:bg-slate-700 hover:border-cyan-400 hover:shadow-cyan-400/20 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all duration-300 backdrop-blur-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM13 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z"
                    ></path>
                  </svg>
                </button>
                <button
                  id="view-list"
                  title="リスト表示"
                  aria-label="記事をリスト形式で表示"
                  class="p-4 rounded-xl bg-slate-800/80 text-slate-400 border border-slate-700/50 shadow-lg hover:bg-slate-700 hover:text-cyan-400 hover:border-cyan-400 hover:shadow-cyan-400/20 focus:outline-none focus:ring-2 focus:ring-cyan-400/50 focus:ring-offset-2 focus:ring-offset-slate-900 transition-all duration-300 backdrop-blur-sm"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                      clip-rule="evenodd"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div
              id="article-list-container"
              class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 md:gap-8"
              style="transition: all 0.3s ease;"
            >
              {
                pagedPosts.map((post: Blog) => (
                  <ArticleCard
                    class="article-card"
                    id={post.id}
                    category={post.category}
                    title={post.title}
                    description={post.description}
                    date={
                      post.publishedAt
                        ? new Date(post.publishedAt).toLocaleDateString("ja-JP")
                        : ""
                    }
                    imageUrl={
                      post.eyecatch?.url
                        ? post.eyecatch.url + "?w=400&h=225&fit=crop"
                        : "/placeholder.svg"
                    }
                    imageUrlList={
                      post.eyecatch?.url
                        ? post.eyecatch.url + "?w=320&h=180&fit=crop"
                        : "/placeholder.svg"
                    }
                  />
                ))
              }
            </div>
            {/* ページネーション */}
            {totalPages > 1 && (
              <div class="mt-12 md:mt-16 flex justify-center">
                <nav class="flex items-center space-x-3">
                  {/* 前へ */}
                  <a
                    href={`?page=${currentPage - 1}`}
                    class={`flex items-center justify-center h-12 w-12 bg-slate-800 border border-slate-700 rounded-xl shadow-lg transition-all duration-300 ${currentPage === 1 ? 'text-slate-600 pointer-events-none' : 'text-slate-300 hover:bg-slate-700 hover:text-cyan-400 hover:border-cyan-400'}`}
                    aria-label="前のページへ"
                    rel="prev"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                  </a>
                  {/* ページ番号 */}
                  {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) =>
                    page === currentPage ? (
                      <span
                        aria-current="page"
                        class="flex items-center justify-center h-12 w-12 bg-gradient-to-r from-cyan-500 to-blue-500 border border-cyan-400 text-white font-bold rounded-xl shadow-lg z-10"
                      >
                        {page}
                      </span>
                    ) : (
                      <a
                        href={`?page=${page}`}
                        class="flex items-center justify-center h-12 w-12 bg-slate-800 border border-slate-700 text-slate-300 rounded-xl shadow-lg hover:bg-slate-700 hover:text-cyan-400 hover:border-cyan-400 transition-all duration-300"
                        aria-label={`${page}ページ目へ`}
                        rel={page === currentPage - 1 ? 'prev' : page === currentPage + 1 ? 'next' : undefined}
                      >
                        {page}
                      </a>
                    )
                  )}
                  {/* 次へ */}
                  <a
                    href={`?page=${currentPage + 1}`}
                    class={`flex items-center justify-center h-12 w-12 bg-slate-800 border border-slate-700 rounded-xl shadow-lg transition-all duration-300 ${currentPage === totalPages ? 'text-slate-600 pointer-events-none' : 'text-slate-300 hover:bg-slate-700 hover:text-cyan-400 hover:border-cyan-400'}`}
                    aria-label="次のページへ"
                    rel="next"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                  </a>
                </nav>
              </div>
            )}
            
            <!-- ブログ一覧へのリンク -->
            <div class="mt-12 md:mt-16 text-center">
              <div class="inline-flex flex-col items-center space-y-4">
                
                <a 
                  href="/blog"
                  class="group inline-flex items-center space-x-3 px-8 py-4 bg-gradient-to-r from-slate-800 to-slate-700 hover:from-cyan-500 hover:to-blue-500 text-white font-semibold rounded-xl border border-slate-600 hover:border-transparent shadow-lg hover:shadow-cyan-500/25 transition-all duration-300 transform hover:scale-105 hover:-translate-y-1"
                >
                  <svg class="w-5 h-5 transition-transform duration-300 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>
                  </svg>
                  <span>すべての記事を見る</span>
                  <svg class="w-4 h-4 transition-transform duration-300 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                  </svg>
                </a>
             

              </div>
            </div>
          </section>
        </div>
        <Sidebar />
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  function initializeViewToggle() {
    const gridButton = document.getElementById("view-grid");
    const listButton = document.getElementById("view-list");
    const container = document.getElementById("article-list-container");

    const updateButtonStyles = (view: "grid" | "list") => {
      const isGrid = view === "grid";
      
      // Grid button styles
      if (isGrid) {
        gridButton?.classList.remove("text-slate-400");
        gridButton?.classList.add("text-cyan-400", "border-cyan-400", "bg-slate-700");
      } else {
        gridButton?.classList.remove("text-cyan-400", "border-cyan-400", "bg-slate-700");
        gridButton?.classList.add("text-slate-400");
      }

      // List button styles
      if (!isGrid) {
        listButton?.classList.remove("text-slate-400");
        listButton?.classList.add("text-cyan-400", "border-cyan-400", "bg-slate-700");
      } else {
        listButton?.classList.remove("text-cyan-400", "border-cyan-400", "bg-slate-700");
        listButton?.classList.add("text-slate-400");
      }
    };

    const setView = (view: "grid" | "list") => {
      if (!container) return;
      const cards = container?.querySelectorAll(".article-card");

      // 既存のアニメーションクラスをリセット
      cards.forEach((card) => {
        card.classList.remove("animate-fade-in", "animate-fade-out");
      });

      // フェードアウトアニメーション
      container.style.opacity = "0.7";
      container.style.transform = "translateY(10px)";
      
      setTimeout(() => {
        if (view === "list") {
          // リストビュー：縦一列配置で各カードは横長レイアウト
          container.classList.remove("grid", "md:grid-cols-2", "xl:grid-cols-3", "gap-6", "md:gap-8");
          container.classList.add("flex", "flex-col", "gap-4", "md:gap-6");
          cards.forEach((card) => {
            card.classList.add("list-view");
            // 確実にリストビュースタイルを適用
            (card as HTMLElement).style.width = "100%";
          });
        } else {
          // グリッドビュー：複数列配置
          container.classList.remove("flex", "flex-col", "gap-4", "md:gap-6");
          container.classList.add("grid", "md:grid-cols-2", "xl:grid-cols-3", "gap-6", "md:gap-8");
          cards.forEach((card) => {
            card.classList.remove("list-view");
            // グリッドビュー用のスタイルをリセット
            (card as HTMLElement).style.width = "";
          });
        }

        // フェードインアニメーション
        requestAnimationFrame(() => {
          container.style.opacity = "1";
          container.style.transform = "translateY(0)";
        });
      }, 150);

      updateButtonStyles(view);
      localStorage.setItem("article_view_mode", view);
    };

    gridButton?.addEventListener("click", () => setView("grid"));
    listButton?.addEventListener("click", () => setView("list"));

    // On page load, apply the saved view mode
    const savedView = localStorage.getItem("article_view_mode");
    setView(savedView === "list" ? "list" : "grid");
  }

  // 複数のイベントに対応
  document.addEventListener("astro:page-load", initializeViewToggle);
  document.addEventListener("swup:contentReplaced", initializeViewToggle);
  document.addEventListener("DOMContentLoaded", initializeViewToggle);

  // First View: Search history suggestions (共有ロジックと同等)
  (function(){
    const STORAGE_KEY = 'search_history';
    function getHistory(): string[] {
      try {
        const raw = localStorage.getItem(STORAGE_KEY) || '[]';
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.map(String) : [];
      } catch {
        return [];
      }
    }
    function setHistory(arr: string[]){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,20))); }catch{}
    }
    const form = document.getElementById('fv-search') as HTMLFormElement | null;
    const input = document.getElementById('fv-q') as HTMLInputElement | null;
    const datalist = document.getElementById('fv-suggest');
    const history = getHistory();
    if (datalist && Array.isArray(history)) {
      datalist.innerHTML = history.map((h)=>`<option value="${h}"></option>`).join('');
    }
    form?.addEventListener('submit', () => {
      const q = (input?.value || '').trim();
      if (!q) return;
      const h = getHistory();
      const next = [q, ...h.filter((x: string)=> x !== q)];
      setHistory(next);
    });
  })();
</script>

---
// src/pages/blog/[id].astro
import { doc, increment, setDoc } from "firebase/firestore";
import Comments from "../../components/Comments.astro";
import LikeButton from "../../components/LikeButton.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { db } from "../../lib/firebase";
import { getBlogDetail, getBlogs } from "../../lib/microcms";

export async function getStaticPaths() {
  const { contents: posts } = await getBlogs({ orders: "-publishedAt" });
  return posts.map((post) => ({
    params: { id: post.id },
  }));
}

const { id } = Astro.params;

if (id) {
  const viewRef = doc(db, "views", id);
  await setDoc(viewRef, { count: increment(1) }, { merge: true });
}

const post = await getBlogDetail(id as string);
---

<BaseLayout>
  <main class="container mx-auto px-4 py-8 md:py-12">
    <article
      class="bg-slate-800 p-6 md:p-10 rounded-xl border border-slate-700"
    >
      <h1 class="text-3xl md:text-4xl font-bold mb-4 text-slate-100">
        {post.title}
      </h1>
      <div class="flex items-center space-x-4 text-sm text-slate-400 mb-6">
        <time datetime={post.publishedAt}>
          公開日: {new Date(post.publishedAt || "").toLocaleDateString("ja-JP")}
        </time>
        <span>カテゴリ: {post.category[0]}</span>
      </div>

      {
        post.eyecatch && (
          <img
            src={post.eyecatch.url}
            alt={`「${post.title}」のアイキャッチ画像`}
            class="w-full h-auto rounded-lg mb-8 shadow-md"
          />
        )
      }

      {/* 本文をHTMLとしてレンダリング */}
      <div class="prose prose-lg max-w-none">
        <Fragment set:html={post.content} />
      </div>

      {/* いいねボタン */}
      <div class="mt-12 pt-8 border-t border-slate-700 flex justify-center">
        <LikeButton postId={post.id} />
      </div>

      {/* コメント欄 */}
      <div class="mt-12 pt-8 border-t border-slate-700">
        <h2 class="text-2xl font-bold mb-6 text-slate-100">コメント</h2>
        <Comments
          pageUrl={Astro.url.href}
          pageIdentifier={post.id}
          pageTitle={post.title}
        />
      </div>
    </article>
  </main>
</BaseLayout>

---
// src/pages/admin/dashboard.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import AdminDashboard from "../../components/AdminDashboard";
import { getBlogs } from "../../lib/microcms";
import { parse } from "cookie";
const allowedUser = import.meta.env.GITHUB_ALLOWED_USER;
const cookies = Astro.request.headers.get("cookie") || "";
const parsed = parse(cookies);
const token = parsed.admin_auth;
let isAuthed = false;
if (token) {
  // GitHub APIでユーザー名を取得
  const userRes = await fetch("https://api.github.com/user", {
    headers: { Authorization: `token ${token}` },
  });
  const user = await userRes.json();
  if (user && user.login === allowedUser) {
    isAuthed = true;
  }
}
if (!isAuthed) {
  return Astro.redirect("/login");
}
const { contents: blogs } = await getBlogs({ limit: 100 });
---

<BaseLayout>
  <main class="dashboard-main">
    <section class="dashboard-section">
      <div class="dashboard-table-wrapper">
        <AdminDashboard client:only="react" blogs={blogs} />
      </div>
    </section>
  </main>
</BaseLayout>
